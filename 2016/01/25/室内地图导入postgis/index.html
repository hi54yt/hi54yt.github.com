<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>室内地图导航路径导入 | sniffer&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="将shapefile导入postgis（以公司四楼五楼路径为例）导入四楼路径规划图，命名为yz_network_lines_04，在命令行中执行：1ogr2ogr -a_srs EPSG:3857 -lco &quot;SCHEMA=public&quot; -lco &quot;COLUMN_TYPES=type=varchar,type_id=integer&quot; -nlt MULTILINESTRING -nln yz_ne">
<meta property="og:type" content="article">
<meta property="og:title" content="室内地图导航路径导入">
<meta property="og:url" content="http://yoursite.com/2016/01/25/室内地图导入postgis/index.html">
<meta property="og:site_name" content="sniffer's blog">
<meta property="og:description" content="将shapefile导入postgis（以公司四楼五楼路径为例）导入四楼路径规划图，命名为yz_network_lines_04，在命令行中执行：1ogr2ogr -a_srs EPSG:3857 -lco &quot;SCHEMA=public&quot; -lco &quot;COLUMN_TYPES=type=varchar,type_id=integer&quot; -nlt MULTILINESTRING -nln yz_ne">
<meta property="og:updated_time" content="2016-03-15T09:28:17.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="室内地图导航路径导入">
<meta name="twitter:description" content="将shapefile导入postgis（以公司四楼五楼路径为例）导入四楼路径规划图，命名为yz_network_lines_04，在命令行中执行：1ogr2ogr -a_srs EPSG:3857 -lco &quot;SCHEMA=public&quot; -lco &quot;COLUMN_TYPES=type=varchar,type_id=integer&quot; -nlt MULTILINESTRING -nln yz_ne">
  
    <link rel="alternative" href="/atom.xml" title="sniffer&#39;s blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.useso.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">sniffer&#39;s blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/links">Links</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-室内地图导入postgis" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/01/25/室内地图导入postgis/" class="article-date">
  <time datetime="2016-01-25T01:57:52.000Z" itemprop="datePublished">2016-01-25</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/gis/">gis</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      室内地图导航路径导入
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>将shapefile导入postgis（以公司四楼五楼路径为例）<br>导入四楼路径规划图，命名为yz_network_lines_04，在命令行中执行：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ogr2ogr <span class="operator">-a</span>_srs EPSG:<span class="number">3857</span> -lco <span class="string">"SCHEMA=public"</span> -lco <span class="string">"COLUMN_TYPES=type=varchar,type_id=integer"</span> -nlt MULTILINESTRING -nln yz_network_lines_04 <span class="operator">-f</span> PostgreSQL <span class="string">"PG:host=localhost port=5432 user=sniffer dbname=camus_development"</span> yz_network_lines_04.shp</span><br></pre></td></tr></table></figure></p>
<p>导入五楼路径规划图，命名为yz_network_lines_05，在命令行中执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ogr2ogr <span class="operator">-a</span>_srs EPSG:<span class="number">3857</span> -lco <span class="string">"SCHEMA=public"</span> -lco <span class="string">"COLUMN_TYPES=type=varchar,type_id=integer"</span> -nlt MULTILINESTRING -nln yz_network_lines_05 <span class="operator">-f</span> PostgreSQL <span class="string">"PG:host=localhost port=5432 user=sniffer dbname=camus_development"</span> yz_network_lines_05.shp</span><br></pre></td></tr></table></figure>
<p>添加pgrouting所需的字段，在pgAdmin或者psql中执行:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="keyword">public</span>.yz_network_lines_04 <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> <span class="keyword">source</span> <span class="built_in">INTEGER</span>;</span></span><br><span class="line"><span class="operator"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="keyword">public</span>.yz_network_lines_04 <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> target <span class="built_in">INTEGER</span>;</span></span><br><span class="line"><span class="operator"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="keyword">public</span>.yz_network_lines_04 <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> <span class="keyword">cost</span> <span class="keyword">DOUBLE</span> <span class="keyword">PRECISION</span>;</span></span><br><span class="line"><span class="operator"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="keyword">public</span>.yz_network_lines_04 <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> <span class="keyword">length</span> <span class="keyword">DOUBLE</span> <span class="keyword">PRECISION</span>;</span></span><br><span class="line"><span class="operator"><span class="keyword">UPDATE</span> <span class="keyword">public</span>.yz_network_lines_04 <span class="keyword">set</span> <span class="keyword">length</span> = ST_Length(wkb_geometry);</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="keyword">public</span>.yz_network_lines_05 <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> <span class="keyword">source</span> <span class="built_in">INTEGER</span>;</span></span><br><span class="line"><span class="operator"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="keyword">public</span>.yz_network_lines_05 <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> target <span class="built_in">INTEGER</span>;</span></span><br><span class="line"><span class="operator"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="keyword">public</span>.yz_network_lines_05 <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> <span class="keyword">cost</span> <span class="keyword">DOUBLE</span> <span class="keyword">PRECISION</span>;</span></span><br><span class="line"><span class="operator"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="keyword">public</span>.yz_network_lines_05 <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> <span class="keyword">length</span> <span class="keyword">DOUBLE</span> <span class="keyword">PRECISION</span>;</span></span><br><span class="line"><span class="operator"><span class="keyword">UPDATE</span> <span class="keyword">public</span>.yz_network_lines_05 <span class="keyword">set</span> <span class="keyword">length</span> = ST_Length(wkb_geometry);</span></span><br></pre></td></tr></table></figure>
<p>生成pgrouting所需的函数（按顺序执行）:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql -U username <span class="operator">-d</span> py_geoan_cb <span class="operator">-a</span> <span class="operator">-f</span> pgr_pointtoid3d.sql</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql -U username <span class="operator">-d</span> py_geoan_cb <span class="operator">-a</span> <span class="operator">-f</span> pgr_createTopology3d.sql</span><br></pre></td></tr></table></figure>
<p>合并四楼五楼路径，导入拓扑结构，需要注意修改表名：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql -U username <span class="operator">-d</span> py_geoan_cb <span class="operator">-a</span> <span class="operator">-f</span> indrz_create_3d_networklines.sql</span><br></pre></td></tr></table></figure></p>
<p>常见问题：</p>
<ol>
<li><p>psql:indrz_create_3d_networklines.sql:81: NOTICE:  ——-&gt; public.networklines_3857 not found<br>原因：用户没有权限<br>解决：ALTER ROLE wwwuser SUPERUSER CREATEROLE CREATEDB REPLICATION;</p>
</li>
<li><p>RGeo::Error::UnsupportedOperation: Proj4 is not supported because the proj4 library was not found at install time.<br>原因：缺少proj本地依赖<br>解决：<br>查看是否支持：</p>
<pre><code><span class="tag">RGeo</span><span class="pseudo">::CoordSys</span><span class="pseudo">::Proj4</span><span class="class">.supported</span>?
</code></pre><p>安装依赖：</p>
<pre><code><span class="label">sudo</span> apt-<span class="preprocessor">get</span> install <span class="keyword">binutils </span>libproj-dev gdal-<span class="keyword">bin</span>
</code></pre><p>重新安装gem：</p>
<pre><code>gem <span class="operator"><span class="keyword">uninstall</span> rgeo
gem <span class="keyword">install</span> rgeo</span>
</code></pre></li>
</ol>
<p>附件：<br>pgr_pointtoid3d.sql</p>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">-- <span class="keyword">Function</span>: <span class="keyword">public</span>.pgr_pointtoid3d(geometry, <span class="built_in">double</span> precision, <span class="keyword">text</span>, <span class="built_in">integer</span>)</span><br><span class="line"></span><br><span class="line">-- DROP <span class="keyword">FUNCTION</span> <span class="keyword">public</span>.pgr_pointtoid3d(geometry, <span class="built_in">double</span> precision, <span class="keyword">text</span>, <span class="built_in">integer</span>);</span><br><span class="line"></span><br><span class="line">CREATE <span class="keyword">OR</span> REPLACE <span class="keyword">FUNCTION</span> <span class="keyword">public</span>.pgr_pointtoid3d(point geometry, tolerance <span class="built_in">double</span> precision, vertname <span class="keyword">text</span>, srid <span class="built_in">integer</span>)</span><br><span class="line">  RETURNS bigint <span class="keyword">AS</span></span><br><span class="line">$BODY$ </span><br><span class="line"><span class="keyword">DECLARE</span></span><br><span class="line">    rec record; </span><br><span class="line">    pid bigint; </span><br><span class="line"></span><br><span class="line">BEGIN</span><br><span class="line">    execute <span class="comment">'SELECT ST_3DDistance(the_geom,ST_GeomFromText(st_astext('||quote_literal(point::text)||'),'||srid||')) AS d, id, the_geom</span></span><br><span class="line">        <span class="keyword">FROM</span> <span class="comment">'||pgr_quote_ident(vertname)||'</span></span><br><span class="line">        <span class="keyword">WHERE</span> ST_DWithin(the_geom, ST_GeomFromText(st_astext(<span class="comment">'||quote_literal(point::text)||'),'||srid||'),'|| tolerance||')</span></span><br><span class="line">        <span class="keyword">ORDER</span> <span class="keyword">BY</span> d</span><br><span class="line">        LIMIT <span class="number">1</span><span class="comment">' INTO rec ;</span></span><br><span class="line">    <span class="keyword">IF</span> rec.id <span class="keyword">is</span> <span class="keyword">not</span> null <span class="keyword">THEN</span></span><br><span class="line">        pid := rec.id;</span><br><span class="line">    <span class="keyword">ELSE</span></span><br><span class="line">        execute <span class="comment">'INSERT INTO '||pgr_quote_ident(vertname)||' (the_geom) VALUES ('||quote_literal(point::text)||')';</span></span><br><span class="line">        pid := lastval();</span><br><span class="line">    <span class="keyword">END</span> <span class="keyword">IF</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">RETURN</span> pid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line">$BODY$</span><br><span class="line">  LANGUAGE plpgsql VOLATILE <span class="keyword">STRICT</span></span><br><span class="line">  COST <span class="number">100</span>;</span><br><span class="line">ALTER <span class="keyword">FUNCTION</span> <span class="keyword">public</span>.pgr_pointtoid3d(geometry, <span class="built_in">double</span> precision, <span class="keyword">text</span>, <span class="built_in">integer</span>)</span><br><span class="line">  OWNER <span class="keyword">TO</span> postgres;</span><br><span class="line">COMMENT <span class="keyword">ON</span> <span class="keyword">FUNCTION</span> <span class="keyword">public</span>.pgr_pointtoid3d(geometry, <span class="built_in">double</span> precision, <span class="keyword">text</span>, <span class="built_in">integer</span>) <span class="keyword">IS</span> <span class="comment">'args: point geometry,tolerance,verticesTable,srid - inserts the point into the vertices table using tolerance to determine if its an existing point and returns the id assigned to it';</span></span><br></pre></td></tr></table></figure>
<p>pgr_createTopology3d.sql<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Function: public.pgr_createtopology3d(text, double precision, text, text, text, text, text)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- DROP FUNCTION public.pgr_createtopology3d(text, double precision, text, text, text, text, text);</span></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> <span class="keyword">public</span>.pgr_createtopology3d(edge_table <span class="built_in">text</span>, tolerance <span class="keyword">double</span> <span class="keyword">precision</span>, the_geom <span class="built_in">text</span> <span class="keyword">DEFAULT</span> <span class="string">'the_geom'</span>::<span class="built_in">text</span>, <span class="keyword">id</span> <span class="built_in">text</span> <span class="keyword">DEFAULT</span> <span class="string">'id'</span>::<span class="built_in">text</span>, <span class="keyword">source</span> <span class="built_in">text</span> <span class="keyword">DEFAULT</span> <span class="string">'source'</span>::<span class="built_in">text</span>, target <span class="built_in">text</span> <span class="keyword">DEFAULT</span> <span class="string">'target'</span>::<span class="built_in">text</span>, rows_where <span class="built_in">text</span> <span class="keyword">DEFAULT</span> <span class="string">'true'</span>::<span class="built_in">text</span>)</span><br><span class="line">  <span class="keyword">RETURNS</span> <span class="built_in">character</span> <span class="built_in">varying</span> <span class="keyword">AS</span></span><br><span class="line">$<span class="keyword">BODY</span>$</span><br><span class="line"></span><br><span class="line"><span class="keyword">DECLARE</span></span><br><span class="line">    points <span class="built_in">record</span>;</span></span><br><span class="line">    sridinfo record;</span><br><span class="line">    source_id bigint;</span><br><span class="line">    target_id bigint;</span><br><span class="line">    totcount bigint;</span><br><span class="line">    rowcount bigint;</span><br><span class="line">    srid integer;</span><br><span class="line">    sql text;</span><br><span class="line">    sname text;</span><br><span class="line">    tname text;</span><br><span class="line">    tabname text;</span><br><span class="line">    vname text;</span><br><span class="line">    vertname text;</span><br><span class="line">    gname text;</span><br><span class="line">    idname text;</span><br><span class="line">    sourcename text;</span><br><span class="line">    targetname text;</span><br><span class="line">    notincluded integer;</span><br><span class="line">    i integer;</span><br><span class="line">    naming record;</span><br><span class="line">    flag boolean;</span><br><span class="line">    query text;</span><br><span class="line">    sourcetype  text;</span><br><span class="line">    targettype text;</span><br><span class="line">    debuglevel text;</span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">BEGIN</span></span><br><span class="line">  <span class="keyword">raise</span> <span class="keyword">notice</span> <span class="string">'PROCESSING:'</span>;</span></span><br><span class="line">  raise notice 'pgr_createTopology3d(''%'',%,''%'',''%'',''%'',''%'',''%'')',edge_table,tolerance,the_geom,id,source,target,rows_where;</span><br><span class="line">  raise notice 'Performing checks, pelase wait .....';</span><br><span class="line">  <span class="operator"><span class="keyword">execute</span> <span class="string">'show client_min_messages'</span> <span class="keyword">into</span> debuglevel;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="operator"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">RAISE</span> DEBUG <span class="string">'Cheking % exists'</span>,edge_table;</span></span><br><span class="line">    <span class="operator"><span class="keyword">execute</span> <span class="string">'select * from pgr_getTableName('</span>||quote_literal(edge_table)||<span class="string">')'</span> <span class="keyword">into</span> naming;</span></span><br><span class="line">    sname=naming.sname;</span><br><span class="line">    tname=naming.tname;</span><br><span class="line">    IF sname IS NULL OR tname IS NULL THEN</span><br><span class="line">  RAISE NOTICE '<span class="comment">-------&gt; % not found',edge_table;</span></span><br><span class="line">        RETURN 'FAIL';</span><br><span class="line">    ELSE</span><br><span class="line">  RAISE DEBUG '  <span class="comment">-----&gt; OK';</span></span><br><span class="line">    <span class="operator"><span class="keyword">END</span> <span class="keyword">IF</span>;</span></span><br><span class="line"></span><br><span class="line">    tabname=sname||'.'||tname;</span><br><span class="line">    vname=tname||'_vertices_pgr';</span><br><span class="line">    vertname= sname||'.'||vname;</span><br><span class="line">    rows_where = ' AND ('||rows_where||')';</span><br><span class="line">  <span class="operator"><span class="keyword">END</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="operator"><span class="keyword">BEGIN</span></span><br><span class="line">       <span class="keyword">raise</span> DEBUG <span class="string">'Checking id column "%" columns in  % '</span>,<span class="keyword">id</span>,tabname;</span></span><br><span class="line">       <span class="operator"><span class="keyword">EXECUTE</span> <span class="string">'select pgr_getColumnName('</span>||quote_literal(tabname)||<span class="string">','</span>||quote_literal(the_geom)||<span class="string">')'</span> <span class="keyword">INTO</span> gname;</span></span><br><span class="line">       <span class="operator"><span class="keyword">EXECUTE</span> <span class="string">'select pgr_getColumnName('</span>||quote_literal(tabname)||<span class="string">','</span>||quote_literal(<span class="keyword">id</span>)||<span class="string">')'</span> <span class="keyword">INTO</span> idname;</span></span><br><span class="line">       IF idname is NULL then</span><br><span class="line">          raise notice  'ERROR: id column "%"  not found in %',id,tabname;</span><br><span class="line">          RETURN 'FAIL';</span><br><span class="line">       <span class="operator"><span class="keyword">END</span> <span class="keyword">IF</span>;</span></span><br><span class="line">       raise DEBUG 'Checking geometry column "%" column  in  % ',the_geom,tabname;</span><br><span class="line">       IF gname is not NULL then</span><br><span class="line">        <span class="operator"><span class="keyword">BEGIN</span></span><br><span class="line">          <span class="keyword">raise</span> DEBUG <span class="string">'Checking the SRID of the geometry "%"'</span>, gname;</span></span><br><span class="line">          query= '<span class="operator"><span class="keyword">SELECT</span> ST_SRID(<span class="string">' || quote_ident(gname) || '</span>) <span class="keyword">as</span> srid <span class="string">'</span><br><span class="line">              || '</span> <span class="keyword">FROM</span> <span class="string">' || pgr_quote_ident(tabname)</span><br><span class="line">              || '</span> <span class="keyword">WHERE</span> <span class="string">' || quote_ident(gname)</span><br><span class="line">              || '</span> <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">LIMIT</span> <span class="number">1</span><span class="string">';</span><br><span class="line">                EXECUTE QUERY</span><br><span class="line">              INTO sridinfo;</span><br><span class="line"></span><br><span class="line">          IF sridinfo IS NULL OR sridinfo.srid IS NULL THEN</span><br><span class="line">                RAISE NOTICE '</span><span class="keyword">ERROR</span>: Can <span class="keyword">not</span> determine the srid <span class="keyword">of</span> the geometry <span class="string">"%"</span> <span class="keyword">in</span> <span class="keyword">table</span> %<span class="string">', the_geom,tabname;</span><br><span class="line">                RETURN '</span>FAIL<span class="string">';</span><br><span class="line">          END IF;</span><br><span class="line">          srid := sridinfo.srid;</span><br><span class="line">          raise DEBUG '</span>  <span class="comment">-----&gt; SRID found %',srid;</span></span><br><span class="line">          <span class="keyword">EXCEPTION</span> <span class="keyword">WHEN</span> OTHERS <span class="keyword">THEN</span></span><br><span class="line">                <span class="keyword">RAISE</span> <span class="keyword">NOTICE</span> <span class="string">'ERROR: Can not determine the srid of the geometry "%" in table %'</span>, the_geom,tabname;</span></span><br><span class="line">                RETURN 'FAIL';</span><br><span class="line">        <span class="operator"><span class="keyword">END</span>;</span></span><br><span class="line">        ELSE</span><br><span class="line">                raise notice  'ERROR: Geometry column "%"  not found in %',the_geom,tabname;</span><br><span class="line">                RETURN 'FAIL';</span><br><span class="line">        <span class="operator"><span class="keyword">END</span> <span class="keyword">IF</span>;</span></span><br><span class="line">  <span class="operator"><span class="keyword">END</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="operator"><span class="keyword">BEGIN</span></span><br><span class="line">       <span class="keyword">raise</span> DEBUG <span class="string">'Checking source column "%" and target column "%"  in  % '</span>,<span class="keyword">source</span>,target,tabname;</span></span><br><span class="line">       <span class="operator"><span class="keyword">EXECUTE</span> <span class="string">'select  pgr_getColumnName('</span>||quote_literal(tabname)||<span class="string">','</span>||quote_literal(<span class="keyword">source</span>)||<span class="string">')'</span> <span class="keyword">INTO</span> sourcename;</span></span><br><span class="line">       <span class="operator"><span class="keyword">EXECUTE</span> <span class="string">'select  pgr_getColumnName('</span>||quote_literal(tabname)||<span class="string">','</span>||quote_literal(target)||<span class="string">')'</span> <span class="keyword">INTO</span> targetname;</span></span><br><span class="line">       IF sourcename is not NULL and targetname is not NULL then</span><br><span class="line">                <span class="comment">--check that the are integer</span></span><br><span class="line">                <span class="operator"><span class="keyword">EXECUTE</span> <span class="string">'select data_type  from information_schema.columns where table_name = '</span>||quote_literal(tname)||</span><br><span class="line">                        <span class="string">' and table_schema='</span>||quote_literal(sname)||<span class="string">' and column_name='</span>||quote_literal(sourcename) <span class="keyword">into</span> sourcetype;</span></span><br><span class="line">                <span class="operator"><span class="keyword">EXECUTE</span> <span class="string">'select data_type  from information_schema.columns where table_name = '</span>||quote_literal(tname)||</span><br><span class="line">                        <span class="string">' and table_schema='</span>||quote_literal(sname)||<span class="string">' and column_name='</span>||quote_literal(targetname) <span class="keyword">into</span> targettype;</span></span><br><span class="line">                IF sourcetype not in('integer','smallint','bigint')  THEN</span><br><span class="line">                raise notice  'ERROR: source column "%" is not of integer type',sourcename;</span><br><span class="line">                RETURN 'FAIL';</span><br><span class="line">                <span class="operator"><span class="keyword">END</span> <span class="keyword">IF</span>;</span></span><br><span class="line">                IF targettype not in('integer','smallint','bigint')  THEN</span><br><span class="line">                raise notice  'ERROR: target column "%" is not of integer type',targetname;</span><br><span class="line">                RETURN 'FAIL';</span><br><span class="line">                <span class="operator"><span class="keyword">END</span> <span class="keyword">IF</span>;</span></span><br><span class="line">                raise DEBUG  '  <span class="comment">------&gt;OK ';</span></span><br><span class="line">       <span class="operator"><span class="keyword">END</span> <span class="keyword">IF</span>;</span></span><br><span class="line">       IF sourcename is NULL THEN</span><br><span class="line">            raise notice  'ERROR: source column "%"  not found in %',source,tabname;</span><br><span class="line">            RETURN 'FAIL';</span><br><span class="line">       <span class="operator"><span class="keyword">END</span> <span class="keyword">IF</span>;</span></span><br><span class="line">       IF targetname is NULL THEN</span><br><span class="line">            raise notice  'ERROR: target column "%"  not found in %',target,tabname;</span><br><span class="line">            RETURN 'FAIL';</span><br><span class="line">       <span class="operator"><span class="keyword">END</span> <span class="keyword">IF</span>;</span></span><br><span class="line">  <span class="operator"><span class="keyword">END</span>;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       IF sourcename=targetname THEN</span><br><span class="line">    raise notice  'ERROR: source and target columns have the same name "%" in %',target,tabname;</span><br><span class="line">                RETURN 'FAIL';</span><br><span class="line">       <span class="operator"><span class="keyword">END</span> <span class="keyword">IF</span>;</span></span><br><span class="line">       IF sourcename=idname THEN</span><br><span class="line">    raise notice  'ERROR: source and id columns have the same name "%" in %',target,tabname;</span><br><span class="line">                RETURN 'FAIL';</span><br><span class="line">       <span class="operator"><span class="keyword">END</span> <span class="keyword">IF</span>;</span></span><br><span class="line">       IF targetname=idname THEN</span><br><span class="line">    raise notice  'ERROR: target and id columns have the same name "%" in %',target,tabname;</span><br><span class="line">                RETURN 'FAIL';</span><br><span class="line">       <span class="operator"><span class="keyword">END</span> <span class="keyword">IF</span>;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="operator"><span class="keyword">BEGIN</span></span><br><span class="line">      <span class="keyword">RAISE</span> DEBUG <span class="string">'Cheking "%" column in % is indexed'</span>,idname,tabname;</span></span><br><span class="line">      if (pgr_isColumnIndexed(tabname,idname)) then</span><br><span class="line">  RAISE DEBUG '  <span class="comment">------&gt;OK';</span></span><br><span class="line">      else</span><br><span class="line">        RAISE DEBUG ' <span class="comment">------&gt; Adding  index "%_%_idx".',tabname,idname;</span></span><br><span class="line">        <span class="operator"><span class="keyword">set</span> client_min_messages  <span class="keyword">to</span> <span class="keyword">warning</span>;</span></span><br><span class="line">        <span class="operator"><span class="keyword">execute</span> <span class="string">'create  index '</span>||pgr_quote_ident(tname||<span class="string">'_'</span>||idname||<span class="string">'_idx'</span>)||<span class="string">'</span><br><span class="line">                         on '</span>||pgr_quote_ident(tabname)||<span class="string">' using btree('</span>||quote_ident(idname)||<span class="string">')'</span>;</span></span><br><span class="line">        <span class="operator"><span class="keyword">execute</span> <span class="string">'set client_min_messages  to '</span>|| debuglevel;</span></span><br><span class="line">      <span class="operator"><span class="keyword">END</span> <span class="keyword">IF</span>;</span></span><br><span class="line">    <span class="operator"><span class="keyword">END</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="operator"><span class="keyword">BEGIN</span></span><br><span class="line">      <span class="keyword">RAISE</span> DEBUG <span class="string">'Cheking "%" column in % is indexed'</span>,sourcename,tabname;</span></span><br><span class="line">      if (pgr_isColumnIndexed(tabname,sourcename)) then</span><br><span class="line">  RAISE DEBUG '  <span class="comment">------&gt;OK';</span></span><br><span class="line">      else</span><br><span class="line">        RAISE DEBUG ' <span class="comment">------&gt; Adding  index "%_%_idx".',tabname,sourcename;</span></span><br><span class="line">        <span class="operator"><span class="keyword">set</span> client_min_messages  <span class="keyword">to</span> <span class="keyword">warning</span>;</span></span><br><span class="line">        <span class="operator"><span class="keyword">execute</span> <span class="string">'create  index '</span>||pgr_quote_ident(tname||<span class="string">'_'</span>||sourcename||<span class="string">'_idx'</span>)||<span class="string">'</span><br><span class="line">                         on '</span>||pgr_quote_ident(tabname)||<span class="string">' using btree('</span>||quote_ident(sourcename)||<span class="string">')'</span>;</span></span><br><span class="line">        <span class="operator"><span class="keyword">execute</span> <span class="string">'set client_min_messages  to '</span>|| debuglevel;</span></span><br><span class="line">      <span class="operator"><span class="keyword">END</span> <span class="keyword">IF</span>;</span></span><br><span class="line">    <span class="operator"><span class="keyword">END</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="operator"><span class="keyword">BEGIN</span></span><br><span class="line">      <span class="keyword">RAISE</span> DEBUG <span class="string">'Cheking "%" column in % is indexed'</span>,targetname,tabname;</span></span><br><span class="line">      if (pgr_isColumnIndexed(tabname,targetname)) then</span><br><span class="line">  RAISE DEBUG '  <span class="comment">------&gt;OK';</span></span><br><span class="line">      else</span><br><span class="line">        RAISE DEBUG ' <span class="comment">------&gt; Adding  index "%_%_idx".',tabname,targetname;</span></span><br><span class="line">        <span class="operator"><span class="keyword">set</span> client_min_messages  <span class="keyword">to</span> <span class="keyword">warning</span>;</span></span><br><span class="line">        <span class="operator"><span class="keyword">execute</span> <span class="string">'create  index '</span>||pgr_quote_ident(tname||<span class="string">'_'</span>||targetname||<span class="string">'_idx'</span>)||<span class="string">'</span><br><span class="line">                         on '</span>||pgr_quote_ident(tabname)||<span class="string">' using btree('</span>||quote_ident(targetname)||<span class="string">')'</span>;</span></span><br><span class="line">        <span class="operator"><span class="keyword">execute</span> <span class="string">'set client_min_messages  to '</span> ||debuglevel;</span></span><br><span class="line">      <span class="operator"><span class="keyword">END</span> <span class="keyword">IF</span>;</span></span><br><span class="line">    <span class="operator"><span class="keyword">END</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="operator"><span class="keyword">BEGIN</span></span><br><span class="line">      <span class="keyword">RAISE</span> DEBUG <span class="string">'Cheking "%" column in % is indexed'</span>,gname,tabname;</span></span><br><span class="line">      if (pgr_iscolumnindexed(tabname,gname)) then</span><br><span class="line">  RAISE DEBUG '  <span class="comment">------&gt;OK';</span></span><br><span class="line">      else</span><br><span class="line">        RAISE DEBUG ' <span class="comment">------&gt; Adding unique index "%_%_gidx".',tabname,gname;</span></span><br><span class="line">        <span class="operator"><span class="keyword">set</span> client_min_messages  <span class="keyword">to</span> <span class="keyword">warning</span>;</span></span><br><span class="line">        <span class="operator"><span class="keyword">execute</span> <span class="string">'CREATE INDEX '</span></span><br><span class="line">            || quote_ident(tname || <span class="string">'_'</span> || gname || <span class="string">'_gidx'</span> )</span><br><span class="line">            || <span class="string">' ON '</span> || pgr_quote_ident(tabname)</span><br><span class="line">            || <span class="string">' USING gist ('</span> || quote_ident(gname) || <span class="string">')'</span>;</span></span><br><span class="line">        <span class="operator"><span class="keyword">execute</span> <span class="string">'set client_min_messages  to '</span>|| debuglevel;</span></span><br><span class="line">      <span class="operator"><span class="keyword">END</span> <span class="keyword">IF</span>;</span></span><br><span class="line">    <span class="operator"><span class="keyword">END</span>;</span></span><br><span class="line">       gname=quote_ident(gname);</span><br><span class="line">       idname=quote_ident(idname);</span><br><span class="line">       sourcename=quote_ident(sourcename);</span><br><span class="line">       targetname=quote_ident(targetname);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="operator"><span class="keyword">BEGIN</span></span><br><span class="line">       <span class="keyword">raise</span> DEBUG <span class="string">'initializing %'</span>,vertname;</span></span><br><span class="line">       <span class="operator"><span class="keyword">execute</span> <span class="string">'select * from pgr_getTableName('</span>||quote_literal(vertname)||<span class="string">')'</span> <span class="keyword">into</span> naming;</span></span><br><span class="line">       IF sname=naming.sname  AND vname=naming.tname  THEN</span><br><span class="line">           <span class="operator"><span class="keyword">execute</span> <span class="string">'TRUNCATE TABLE '</span>||pgr_quote_ident(vertname)||<span class="string">' RESTART IDENTITY'</span>;</span></span><br><span class="line">           <span class="operator"><span class="keyword">execute</span> <span class="string">'SELECT DROPGEOMETRYCOLUMN('</span>||quote_literal(sname)||<span class="string">','</span>||quote_literal(vname)||<span class="string">','</span>||quote_literal(<span class="string">'the_geom'</span>)||<span class="string">')'</span>;</span></span><br><span class="line">       ELSE</span><br><span class="line">           <span class="operator"><span class="keyword">set</span> client_min_messages  <span class="keyword">to</span> <span class="keyword">warning</span>;</span></span><br><span class="line">           <span class="operator"><span class="keyword">execute</span> <span class="string">'CREATE TABLE '</span>||pgr_quote_ident(vertname)||<span class="string">' (id bigserial PRIMARY KEY,cnt integer,chk integer,ein integer,eout integer)'</span>;</span></span><br><span class="line">       <span class="operator"><span class="keyword">END</span> <span class="keyword">IF</span>;</span></span><br><span class="line">       <span class="operator"><span class="keyword">execute</span> <span class="string">'select addGeometryColumn('</span>||quote_literal(sname)||<span class="string">','</span>||quote_literal(vname)||<span class="string">','</span>||</span><br><span class="line">                quote_literal(<span class="string">'the_geom'</span>)||<span class="string">','</span>|| srid||<span class="string">', '</span>||quote_literal(<span class="string">'POINT'</span>)||<span class="string">', 3)'</span>;</span></span><br><span class="line">       <span class="operator"><span class="keyword">execute</span> <span class="string">'CREATE INDEX '</span>||quote_ident(vname||<span class="string">'_the_geom_idx'</span>)||<span class="string">' ON '</span>||pgr_quote_ident(vertname)||<span class="string">'  USING GIST (the_geom)'</span>;</span></span><br><span class="line">       <span class="operator"><span class="keyword">execute</span> <span class="string">'set client_min_messages  to '</span>|| debuglevel;</span></span><br><span class="line">       raise DEBUG  '  <span class="comment">------&gt;OK';</span></span><br><span class="line">    <span class="operator"><span class="keyword">END</span>;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="operator"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">sql</span> = <span class="string">'select * from '</span>||pgr_quote_ident(tabname)||<span class="string">' WHERE true'</span>||rows_where ||<span class="string">' limit 1'</span>;</span></span><br><span class="line">    <span class="operator"><span class="keyword">EXECUTE</span> <span class="keyword">sql</span> <span class="keyword">into</span> <span class="keyword">i</span>;</span></span><br><span class="line">    sql = '<span class="operator"><span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> <span class="string">'||pgr_quote_ident(tabname)||'</span> <span class="keyword">WHERE</span> (<span class="string">' || gname || '</span> <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">AND</span> <span class="string">'||</span><br><span class="line">    idname||'</span> <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>)=<span class="literal">false</span> <span class="string">'||rows_where;</span><br><span class="line">    EXECUTE SQL  into notincluded;</span><br><span class="line">    EXCEPTION WHEN OTHERS THEN  BEGIN</span><br><span class="line">         RAISE NOTICE '</span><span class="keyword">ERROR</span>: Condition <span class="keyword">is</span> <span class="keyword">not</span> correct, please <span class="keyword">execute</span> the <span class="keyword">following</span> <span class="keyword">query</span> <span class="keyword">to</span> <span class="keyword">test</span> your condition<span class="string">';</span><br><span class="line">         RAISE NOTICE '</span>%<span class="string">',sql;</span><br><span class="line">         RETURN '</span>FAIL<span class="string">';</span><br><span class="line">    END;</span><br><span class="line">  END;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    BEGIN</span><br><span class="line">    raise notice '</span>Creating topology3d, Please <span class="keyword">wait</span>...<span class="string">';</span><br><span class="line">    execute '</span><span class="keyword">UPDATE</span> <span class="string">' || pgr_quote_ident(tabname) ||</span><br><span class="line">            '</span> <span class="keyword">SET</span> <span class="string">'||sourcename||'</span> = <span class="literal">NULL</span>,<span class="string">'||targetname||'</span> = <span class="literal">NULL</span><span class="string">';</span><br><span class="line">    rowcount := 0;</span><br><span class="line">    FOR points IN EXECUTE '</span><span class="keyword">SELECT</span> <span class="string">' || idname || '</span>::<span class="built_in">bigint</span> <span class="keyword">AS</span> <span class="keyword">id</span>,<span class="string">'</span><br><span class="line">        || '</span> PGR_StartPoint(<span class="string">' || gname || '</span>) <span class="keyword">AS</span> <span class="keyword">source</span>,<span class="string">'</span><br><span class="line">        || '</span> PGR_EndPoint(<span class="string">'   || gname || '</span>) <span class="keyword">AS</span> target<span class="string">'</span><br><span class="line">        || '</span> <span class="keyword">FROM</span> <span class="string">'  || pgr_quote_ident(tabname)</span><br><span class="line">        || '</span> <span class="keyword">WHERE</span> <span class="string">' || gname || '</span> <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">AND</span> <span class="string">' || idname||'</span> <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="string">'||rows_where</span><br><span class="line">    LOOP</span><br><span class="line"></span><br><span class="line">        rowcount := rowcount + 1;</span><br><span class="line">        IF rowcount % 1000 = 0 THEN</span><br><span class="line">            RAISE NOTICE '</span>% edges processed<span class="string">', rowcount;</span><br><span class="line">        END IF;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        source_id := pgr_pointToId3d(points.source, tolerance,vertname,srid);</span><br><span class="line">        target_id := pgr_pointToId3d(points.target, tolerance,vertname,srid);</span><br><span class="line">        BEGIN</span><br><span class="line">        sql := '</span><span class="keyword">UPDATE</span> <span class="string">' || pgr_quote_ident(tabname) ||</span><br><span class="line">            '</span> <span class="keyword">SET</span> <span class="string">'||sourcename||'</span> = <span class="string">'|| source_id::text || '</span>,<span class="string">'||targetname||'</span> = <span class="string">' || target_id::text ||</span><br><span class="line">            '</span> <span class="keyword">WHERE</span> <span class="string">' || idname || '</span> =  <span class="string">' || points.id::text;</span><br><span class="line"></span><br><span class="line">        IF sql IS NULL THEN</span><br><span class="line">            RAISE NOTICE '</span><span class="keyword">WARNING</span>: <span class="keyword">UPDATE</span> % <span class="keyword">SET</span> <span class="keyword">source</span> = %, target = % <span class="keyword">WHERE</span> % = % <span class="string">', tabname, source_id::text, target_id::text, idname,  points.id::text;</span><br><span class="line">        ELSE</span><br><span class="line">            EXECUTE sql;</span><br><span class="line">        END IF;</span><br><span class="line">        EXCEPTION WHEN OTHERS THEN</span><br><span class="line">            RAISE NOTICE '</span>%<span class="string">', SQLERRM;</span><br><span class="line">            RAISE NOTICE '</span>%<span class="string">',sql;</span><br><span class="line">            RETURN '</span>FAIL<span class="string">';</span><br><span class="line">        end;</span><br><span class="line">    END LOOP;</span><br><span class="line">    raise notice '</span><span class="comment">-------------&gt; TOPOLOGY 3D CREATED FOR  % edges', rowcount;</span></span><br><span class="line">    <span class="keyword">RAISE</span> <span class="keyword">NOTICE</span> <span class="string">'Rows with NULL geometry or NULL id: %'</span>,notincluded;</span></span><br><span class="line">    Raise notice 'Vertices table for table % is: %',pgr_quote_ident(tabname),pgr_quote_ident(vertname);</span><br><span class="line">    raise notice '<span class="comment">----------------------------------------------';</span></span><br><span class="line">    <span class="operator"><span class="keyword">END</span>;</span></span><br><span class="line">    RETURN 'OK';</span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">END</span>;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$BODY$</span><br><span class="line">  LANGUAGE plpgsql VOLATILE STRICT</span><br><span class="line">  COST 100;</span><br><span class="line"><span class="operator"><span class="keyword">ALTER</span> <span class="keyword">FUNCTION</span> <span class="keyword">public</span>.pgr_createtopology3d(<span class="built_in">text</span>, <span class="keyword">double</span> <span class="keyword">precision</span>, <span class="built_in">text</span>, <span class="built_in">text</span>, <span class="built_in">text</span>, <span class="built_in">text</span>, <span class="built_in">text</span>)</span><br><span class="line">  OWNER <span class="keyword">TO</span> postgres;</span></span><br><span class="line">COMMENT ON FUNCTION public.pgr_createtopology3d(text, double precision, text, text, text, text, text) IS 'args: edge_table,tolerance, the_geom:=''the_geom'',source:=''source'', target:=''target'',rows_where:=''true'' - fills columns source and target in the geometry table and creates a vertices table for selected rows';</span><br></pre></td></tr></table></figure></p>
<p>indrz_create_3d_networklines.sql<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- if not, go ahead and update</span></span><br><span class="line"><span class="comment">-- make sure tables dont exist</span></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> <span class="keyword">public</span>.yz_network_lines_04_routing;</span></span><br><span class="line"><span class="operator"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> <span class="keyword">public</span>.yz_network_lines_05_routing;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- convert to 3d coordinates with EPSG:3857</span></span><br><span class="line"><span class="operator"><span class="keyword">SELECT</span> ogc_fid, ST_Force_3d(ST_Transform(ST_Force_2D(st_geometryN(wkb_geometry, <span class="number">1</span>)),<span class="number">3857</span>)) <span class="keyword">AS</span> wkb_geometry,</span><br><span class="line">  type_id, <span class="keyword">cost</span>, <span class="keyword">length</span>, <span class="number">0</span> <span class="keyword">AS</span> <span class="keyword">source</span>, <span class="number">0</span> <span class="keyword">AS</span> target</span><br><span class="line">  <span class="keyword">INTO</span> <span class="keyword">public</span>.yz_network_lines_04_routing</span><br><span class="line">  <span class="keyword">FROM</span> <span class="keyword">public</span>.yz_network_lines_04;</span></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">SELECT</span> ogc_fid, ST_Force_3d(ST_Transform(ST_Force_2D(st_geometryN(wkb_geometry, <span class="number">1</span>)),<span class="number">3857</span>)) <span class="keyword">AS</span> wkb_geometry,</span><br><span class="line">  type_id, <span class="keyword">cost</span>, <span class="keyword">length</span>, <span class="number">0</span> <span class="keyword">AS</span> <span class="keyword">source</span>, <span class="number">0</span> <span class="keyword">AS</span> target</span><br><span class="line">  <span class="keyword">INTO</span> <span class="keyword">public</span>.yz_network_lines_05_routing</span><br><span class="line">  <span class="keyword">FROM</span> <span class="keyword">public</span>.yz_network_lines_05;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- fill the 3rd coordinate according to their floor number</span></span><br><span class="line"><span class="operator"><span class="keyword">UPDATE</span> <span class="keyword">public</span>.yz_network_lines_04_routing <span class="keyword">SET</span> wkb_geometry=ST_Translate(ST_Force_3Dz(wkb_geometry),<span class="number">0</span>,<span class="number">0</span>,<span class="number">4</span>);</span></span><br><span class="line"><span class="operator"><span class="keyword">UPDATE</span> <span class="keyword">public</span>.yz_network_lines_05_routing <span class="keyword">SET</span> wkb_geometry=ST_Translate(ST_Force_3Dz(wkb_geometry),<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>);</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">UPDATE</span> <span class="keyword">public</span>.yz_network_lines_04_routing <span class="keyword">SET</span> <span class="keyword">length</span> =ST_Length(wkb_geometry);</span></span><br><span class="line"><span class="operator"><span class="keyword">UPDATE</span> <span class="keyword">public</span>.yz_network_lines_05_routing <span class="keyword">SET</span> <span class="keyword">length</span> =ST_Length(wkb_geometry);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- no cost should be 0 or NULL/empty</span></span><br><span class="line"><span class="operator"><span class="keyword">UPDATE</span> <span class="keyword">public</span>.yz_network_lines_04_routing <span class="keyword">SET</span> <span class="keyword">cost</span>=<span class="number">1</span> <span class="keyword">WHERE</span> <span class="keyword">cost</span>=<span class="number">0</span> <span class="keyword">or</span> <span class="keyword">cost</span> <span class="keyword">IS</span> <span class="literal">NULL</span>;</span></span><br><span class="line"><span class="operator"><span class="keyword">UPDATE</span> <span class="keyword">public</span>.yz_network_lines_05_routing <span class="keyword">SET</span> <span class="keyword">cost</span>=<span class="number">1</span> <span class="keyword">WHERE</span> <span class="keyword">cost</span>=<span class="number">0</span> <span class="keyword">or</span> <span class="keyword">cost</span> <span class="keyword">IS</span> <span class="literal">NULL</span>;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- update unique ids ogc_fid accordingly</span></span><br><span class="line"><span class="operator"><span class="keyword">UPDATE</span> <span class="keyword">public</span>.yz_network_lines_04_routing <span class="keyword">SET</span> ogc_fid=ogc_fid+<span class="number">100000</span>;</span></span><br><span class="line"><span class="operator"><span class="keyword">UPDATE</span> <span class="keyword">public</span>.yz_network_lines_05_routing <span class="keyword">SET</span> ogc_fid=ogc_fid+<span class="number">200000</span>;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- merge all networkline floors into a single table for routing</span></span><br><span class="line"><span class="operator"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="keyword">public</span>.networklines_3857;</span></span><br><span class="line"><span class="operator"><span class="keyword">SELECT</span> * <span class="keyword">INTO</span> <span class="keyword">public</span>.networklines_3857 <span class="keyword">FROM</span></span><br><span class="line">(</span><br><span class="line">(<span class="keyword">SELECT</span> ogc_fid, wkb_geometry, <span class="keyword">length</span>, type_id, <span class="keyword">length</span>*o1.<span class="keyword">cost</span> <span class="keyword">as</span> total_cost,</span><br><span class="line">   <span class="number">4</span> <span class="keyword">as</span> layer <span class="keyword">FROM</span> <span class="keyword">public</span>.yz_network_lines_04_routing o1) <span class="keyword">UNION</span></span><br><span class="line">(<span class="keyword">SELECT</span> ogc_fid, wkb_geometry, <span class="keyword">length</span>, type_id, <span class="keyword">length</span>*o2.<span class="keyword">cost</span> <span class="keyword">as</span> total_cost,</span><br><span class="line">   <span class="number">5</span> <span class="keyword">as</span> layer <span class="keyword">FROM</span> <span class="keyword">public</span>.yz_network_lines_05_routing o2))</span><br><span class="line"><span class="keyword">as</span> foo <span class="keyword">ORDER</span> <span class="keyword">BY</span> ogc_fid;</span></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> wkb_geometry_gist_index</span><br><span class="line">   <span class="keyword">ON</span> <span class="keyword">public</span>.networklines_3857 <span class="keyword">USING</span> gist (wkb_geometry);</span></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> ogc_fid_idx</span><br><span class="line">   <span class="keyword">ON</span> <span class="keyword">public</span>.networklines_3857 <span class="keyword">USING</span> btree (ogc_fid <span class="keyword">ASC</span> <span class="keyword">NULLS</span> <span class="keyword">LAST</span>);</span></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> network_layer_idx</span><br><span class="line">  <span class="keyword">ON</span> <span class="keyword">public</span>.networklines_3857</span><br><span class="line">  <span class="keyword">USING</span> <span class="keyword">hash</span></span><br><span class="line">  (layer);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- create populate geometry view with info</span></span><br><span class="line"><span class="operator"><span class="keyword">SELECT</span> Populate_Geometry_Columns(<span class="string">'public.networklines_3857'</span>::regclass);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- update stairs, ramps and elevators to match with the next layer</span></span><br><span class="line"><span class="operator"><span class="keyword">UPDATE</span> <span class="keyword">public</span>.networklines_3857 <span class="keyword">SET</span> wkb_geometry=ST_AddPoint(wkb_geometry,</span><br><span class="line">  ST_EndPoint(ST_Translate(wkb_geometry,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>)))</span><br><span class="line">  <span class="keyword">WHERE</span> type_id=<span class="number">3</span> <span class="keyword">OR</span> type_id=<span class="number">5</span> <span class="keyword">OR</span> type_id=<span class="number">7</span>;</span></span><br><span class="line"><span class="comment">-- remove the second last point</span></span><br><span class="line"><span class="operator"><span class="keyword">UPDATE</span> <span class="keyword">public</span>.networklines_3857 <span class="keyword">SET</span> wkb_geometry=ST_RemovePoint(wkb_geometry,ST_NPoints(wkb_geometry) - <span class="number">2</span>)</span><br><span class="line">  <span class="keyword">WHERE</span> type_id=<span class="number">3</span> <span class="keyword">OR</span> type_id=<span class="number">5</span> <span class="keyword">OR</span> type_id=<span class="number">7</span>;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- add columns source and target</span></span><br><span class="line"><span class="operator"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="keyword">public</span>.networklines_3857 <span class="keyword">add</span> <span class="keyword">column</span> <span class="keyword">source</span> <span class="built_in">integer</span>;</span></span><br><span class="line"><span class="operator"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="keyword">public</span>.networklines_3857 <span class="keyword">add</span> <span class="keyword">column</span> target <span class="built_in">integer</span>;</span></span><br><span class="line"><span class="operator"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="keyword">public</span>.networklines_3857 OWNER <span class="keyword">TO</span> postgres;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- we dont need the temporary tables any more, delete them</span></span><br><span class="line"><span class="operator"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="keyword">public</span>.yz_network_lines_04_routing;</span></span><br><span class="line"><span class="operator"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="keyword">public</span>.yz_network_lines_05_routing;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- remove route nodes vertices table if exists</span></span><br><span class="line"><span class="operator"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="keyword">public</span>.networklines_3857_vertices_pgr;</span></span><br><span class="line"><span class="comment">-- building routing network vertices (fills source and target columns in those new tables)</span></span><br><span class="line"><span class="operator"><span class="keyword">SELECT</span> <span class="keyword">public</span>.pgr_createTopology3d(<span class="string">'public.networklines_3857'</span>, <span class="number">0.0001</span>, <span class="string">'wkb_geometry'</span>, <span class="string">'ogc_fid'</span>);</span></span><br></pre></td></tr></table></figure></p>
<p>参考：<br><a href="https://www.packtpub.com/big-data-and-business-intelligence/python-geospatial-analysis-cookbook" target="_blank" rel="external">《Python Geospatial Analysis Cookbook》</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/01/25/室内地图导入postgis/" data-id="cim328z5v000bon1atn8qj6j9" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/gis-室内地图/">gis 室内地图</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/03/01/mac-cheatsheet/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          打造顺手的开发环境
        
      </div>
    </a>
  
  
    <a href="/2015/11/05/处理fetch-error/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">处理fetch error</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Mac/">Mac</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ReactNative/">ReactNative</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/gis/">gis</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">hexo</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ionic/">ionic</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/厨艺/">厨艺</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/感想/">感想</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/昔日归档/">昔日归档</a><span class="category-list-count">78</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/50元/">50元</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/605/">605</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MFC/">MFC</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gis-室内地图/">gis 室内地图</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wolf/">wolf</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/书/">书</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/事业/">事业</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/做事/">做事</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/做人/">做人</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/出力/">出力</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/出钱/">出钱</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/刘翔/">刘翔</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/创业/">创业</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/史玉柱/">史玉柱</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/地震/">地震</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/坑/">坑</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/多难兴邦/">多难兴邦</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/头七/">头七</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/室内地图/">室内地图</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/忠告/">忠告</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/成功/">成功</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/救急不救穷/">救急不救穷</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/机会/">机会</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/机遇/">机遇</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/校内/">校内</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/毕业/">毕业</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/毛泽东-实践-认识/">毛泽东;实践;认识</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/沉思录/">沉思录</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/法律/">法律</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/清华/">清华</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/灾难/">灾难</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/爱因斯坦/">爱因斯坦</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/狼/">狼</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/用心/">用心</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/电梯/">电梯</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/网站/">网站</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/老汉/">老汉</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/职业/">职业</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/补课/">补课</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/见义勇为/">见义勇为</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/角斗士/">角斗士</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/赚钱/">赚钱</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/50元/" style="font-size: 10px;">50元</a> <a href="/tags/605/" style="font-size: 10px;">605</a> <a href="/tags/MFC/" style="font-size: 10px;">MFC</a> <a href="/tags/gis-室内地图/" style="font-size: 10px;">gis 室内地图</a> <a href="/tags/wolf/" style="font-size: 10px;">wolf</a> <a href="/tags/书/" style="font-size: 10px;">书</a> <a href="/tags/事业/" style="font-size: 10px;">事业</a> <a href="/tags/做事/" style="font-size: 10px;">做事</a> <a href="/tags/做人/" style="font-size: 10px;">做人</a> <a href="/tags/出力/" style="font-size: 10px;">出力</a> <a href="/tags/出钱/" style="font-size: 10px;">出钱</a> <a href="/tags/刘翔/" style="font-size: 10px;">刘翔</a> <a href="/tags/创业/" style="font-size: 10px;">创业</a> <a href="/tags/史玉柱/" style="font-size: 10px;">史玉柱</a> <a href="/tags/地震/" style="font-size: 20px;">地震</a> <a href="/tags/坑/" style="font-size: 10px;">坑</a> <a href="/tags/多难兴邦/" style="font-size: 15px;">多难兴邦</a> <a href="/tags/头七/" style="font-size: 10px;">头七</a> <a href="/tags/室内地图/" style="font-size: 15px;">室内地图</a> <a href="/tags/忠告/" style="font-size: 10px;">忠告</a> <a href="/tags/成功/" style="font-size: 10px;">成功</a> <a href="/tags/救急不救穷/" style="font-size: 10px;">救急不救穷</a> <a href="/tags/机会/" style="font-size: 10px;">机会</a> <a href="/tags/机遇/" style="font-size: 10px;">机遇</a> <a href="/tags/校内/" style="font-size: 10px;">校内</a> <a href="/tags/毕业/" style="font-size: 10px;">毕业</a> <a href="/tags/毛泽东-实践-认识/" style="font-size: 10px;">毛泽东;实践;认识</a> <a href="/tags/沉思录/" style="font-size: 10px;">沉思录</a> <a href="/tags/法律/" style="font-size: 15px;">法律</a> <a href="/tags/清华/" style="font-size: 10px;">清华</a> <a href="/tags/灾难/" style="font-size: 10px;">灾难</a> <a href="/tags/爱因斯坦/" style="font-size: 10px;">爱因斯坦</a> <a href="/tags/狼/" style="font-size: 10px;">狼</a> <a href="/tags/用心/" style="font-size: 10px;">用心</a> <a href="/tags/电梯/" style="font-size: 10px;">电梯</a> <a href="/tags/网站/" style="font-size: 10px;">网站</a> <a href="/tags/老汉/" style="font-size: 10px;">老汉</a> <a href="/tags/职业/" style="font-size: 10px;">职业</a> <a href="/tags/补课/" style="font-size: 10px;">补课</a> <a href="/tags/见义勇为/" style="font-size: 10px;">见义勇为</a> <a href="/tags/角斗士/" style="font-size: 10px;">角斗士</a> <a href="/tags/赚钱/" style="font-size: 10px;">赚钱</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">June 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">May 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/06/">June 2012</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/05/">May 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/07/">July 2011</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/09/">September 2010</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/08/">August 2010</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/07/">July 2010</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/04/">April 2010</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/03/">March 2010</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/02/">February 2010</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/01/">January 2010</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2009/12/">December 2009</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2009/11/">November 2009</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2009/10/">October 2009</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2009/09/">September 2009</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2009/08/">August 2009</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2009/07/">July 2009</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2009/03/">March 2009</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2009/01/">January 2009</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2008/11/">November 2008</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2008/10/">October 2008</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2008/09/">September 2008</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2008/08/">August 2008</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2008/07/">July 2008</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2008/06/">June 2008</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2008/05/">May 2008</a><span class="archive-list-count">17</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/03/22/正确配置geoserver标签label的姿势/">正确配置geoserver标签(label)的姿势</a>
          </li>
        
          <li>
            <a href="/2016/03/22/geoserver地图显示图标/">geoserver地图显示图标</a>
          </li>
        
          <li>
            <a href="/2016/03/09/set-hexo-jquery-google-fonts-cdn/">解决hexo的jquery和fonts被墙</a>
          </li>
        
          <li>
            <a href="/2016/03/07/add-jvm-fonts/">解决geoserver中文label乱码问题</a>
          </li>
        
          <li>
            <a href="/2016/03/07/ionic-cheatsheet/">ionic-cheatsheet</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 sniffer<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/links" class="mobile-nav-link">Links</a>
  
</nav>
    

<script src="//ajax.useso.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>

  </div>
</body>
</html>